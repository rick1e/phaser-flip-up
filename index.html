<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
</head>

<body>

    <script>
        const width = 400
        const height = 700
        const fontSize = 10

        var config = {
            type: Phaser.AUTO,
            width: width,
            height: height,
            backgroundColor: '#4488aa',
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 200 }
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            },
            scale: {
                //zoom: 4//1 / window.devicePixelRatio,
                //width: width * window.devicePixelRatio,
                //height: height * window.devicePixelRatio
            }
        };

        var game = new Phaser.Game(config);
        var startTime = 0;
        var timer;
        var clockTimer;
        var clockValue = 0;
        var text;
        var text2;
        var aiText;
        var aiSpeedText;

        function preload() {
            //this.load.setBaseURL('http://labs.phaser.io');

            //this.load.image('sky', 'assets/skies/space3.png');
            //this.load.image('logo', 'assets/sprites/phaser3-logo.png');
            //this.load.image('red', 'assets/particles/red.png');
        }

        function create() {

            var board = [0, 0, 0, 0, 0, 0, 0, 0, 0];
            var v2 = 0;
            var aiLevel = "OFF";
            var aiSpeed = 400;

            let checkCompleted = function (board) {
                let sample = board[0]
                let result = board.reduce((allSame, cell) => {
                    return allSame && cell === sample
                }, true)
                return result
            }

            let flip = function (rect, index) {
                board[index] = (board[index] + 1) % 2;
                rect.setFillStyle(board[index] === 0 ? red : blue);
                console.log(board)
            }

            let clock = function () {

                if (!checkCompleted(board)) {
                    clockValue += 50
                    return
                }
            }

            let hardAI = function () {
                let blueIndices = []
                board.filter((cell, index) => {
                    if (cell === 1) {
                        blueIndices.push(index)
                    }
                });
                let blueIndex = Math.floor(Math.random() * blueIndices.length)
                if (checkCompleted(board)) {
                    //endGame()
                    if (timer) {
                        //timer.destroy()
                        timer.reset({ delay: aiSpeed, callback: AIloop, loop: true, paused: true });
                    }
                    return
                }
                if (blueIndices.length > 0) {
                    let flipIndex = blueIndices[blueIndex]
                    flip(cells[flipIndex], flipIndex)
                }
                console.log(blueIndices)
            }

            let AI = function () {

                if (!checkCompleted(board)) {
                    var index = Phaser.Math.Between(0, board.length - 1)
                    flip(cells[index], index)
                }
                else {
                    if (timer) {
                        //timer.destroy()
                        timer.reset({ delay: aiSpeed, callback: AIloop, loop: true, paused: true });
                    }
                }

            }

            let startGame = function (cells) {
                board = [0, 0, 0, 0, 0, 0, 0, 0, 0]
                clockValue = 0
                for (let i = 0; i < board.length; i++) {
                    cells[i].setFillStyle(red);
                }
            }

            let AIloop = function () {
                console.log("looping", timer.delay, " paused ", timer.paused)
                switch (aiLevel) {
                    case "OFF":
                        return;
                        break;
                    case "EASY":
                        AI();
                        break;
                    case "HARD":
                        hardAI()
                        break;

                }

            }

            let startAI = function () {
                //timer =
                if (aiLevel != "OFF") {
                    timer.reset({ delay: aiSpeed, callback: AIloop, loop: true });
                }
                //this.time.addEvent({ delay: aiSpeed, callback: AIloop, loop: true });
            }

            let createButtonText = function (game, x, y, width, height, text) {
                game.add.text(0, 0, text, { align: 'center', boundsAlignH: "center", boundsAlignV: "middle", fontSize: fontSize * window.devicePixelRatio }).setPosition(x - width / 4, y - height / 4);
            }

            //this.add.image(400, 300, 'sky');
            var red = 0xD1495B;
            var blue = 0x004385;
            var pink = 0xff33ff;
            var gray = 0x333333;
            var green = 0x1E5C28;

            var width = 95;

            var cells = []

            for (let i = 0; i < board.length; i++) {
                var row = 100 + ((i % 3) * 100);
                var col = 200 + (Math.floor(i / 3) * 100);
                cells.push(this.add.rectangle(row, col, width, width, red).setInteractive());
                cells[i].on('pointerdown', function () {
                    if (checkCompleted(board) && board[0] == 1) {
                        startGame(cells)
                        return
                    }
                    if (checkCompleted(board)) {
                        clockValue = 0
                        startAI()
                    }
                    flip(this, i)
                });
            }
            timer = this.time.addEvent({ delay: aiSpeed, callback: AIloop, loop: true, paused: true });
            clockTimer = this.time.addEvent({ delay: 50, callback: clock, loop: true });
            text = this.add.text(32, 32, "", { fontSize: fontSize * window.devicePixelRatio });
            text2 = this.add.text(32, 52, "", { fontSize: fontSize * window.devicePixelRatio });
            aiText = this.add.text(32, 420, "", { fontSize: fontSize * window.devicePixelRatio });
            aiText.setText('AI Difficulty:' + aiLevel);
            aiSpeedText = this.add.text(32, 450);
            aiSpeedText.setText('AI Speed:' + aiSpeed);

            var offButton = this.add.rectangle(100, 500, 100, 30, pink).setInteractive();
            createButtonText(this, 100, 500, 100, 30, "OFF");
            var easyButton = this.add.rectangle(220, 500, 100, 30, gray).setInteractive();
            createButtonText(this, 220, 500, 100, 30, "EASY");
            var hardButton = this.add.rectangle(340, 500, 100, 30, gray).setInteractive();
            createButtonText(this, 340, 500, 100, 30, "HARD");


            var slowButton = this.add.rectangle(100, 540, 100, 30, pink).setInteractive();
            createButtonText(this, 100, 540, 100, 30, "500ms");
            var medButton = this.add.rectangle(220, 540, 100, 30, gray).setInteractive();
            createButtonText(this, 220, 540, 100, 30, "400ms");
            var fastButton = this.add.rectangle(340, 540, 100, 30, gray).setInteractive();
            createButtonText(this, 340, 540, 100, 30, "300ms");

            //var startButton = this.add.rectangle(100, 600, 100, 40, green).setInteractive();
            //createButtonText(this, 100, 600, 100, 40, "RESET");


            const clearButtons = () => {
                offButton.setFillStyle(gray)
                easyButton.setFillStyle(gray)
                hardButton.setFillStyle(gray)
            }
            const clearSpeedButtons = () => {
                slowButton.setFillStyle(gray)
                medButton.setFillStyle(gray)
                fastButton.setFillStyle(gray)
            }

            slowButton.on('pointerdown', function () {
                aiSpeed = 500;
                //timer.reset({ delay: aiSpeed, callback: AIloop, loop: true });
                aiSpeedText.setText('AI Speed:' + aiSpeed);
                clearSpeedButtons();
                this.setFillStyle(pink)
            });
            medButton.on('pointerdown', function () {
                aiSpeed = 400;
                //timer.reset({ delay: aiSpeed, callback: AIloop, loop: true });
                aiSpeedText.setText('AI Speed:' + aiSpeed);
                clearSpeedButtons();
                this.setFillStyle(pink)
            });
            fastButton.on('pointerdown', function () {
                aiSpeed = 300;
                //timer.reset({ delay: aiSpeed, callback: AIloop, loop: true });
                aiSpeedText.setText('AI Speed:' + aiSpeed);
                clearSpeedButtons();
                this.setFillStyle(pink)
            });


            offButton.on('pointerdown', function () {
                aiLevel = "OFF";
                aiText.setText('AI Difficulty:' + aiLevel);
                clearButtons();
                this.setFillStyle(pink)
            });
            easyButton.on('pointerdown', function () {
                aiLevel = "EASY";
                aiText.setText('AI Difficulty:' + aiLevel);
                clearButtons();
                this.setFillStyle(pink)
            });
            hardButton.on('pointerdown', function () {
                aiLevel = "HARD";
                aiText.setText('AI Difficulty:' + aiLevel);
                clearButtons();
                this.setFillStyle(pink)
            });

            //startButton.on('pointerdown', function () {
            //    startGame(cells)
            //});


        }

        function update(time, delta) {
            text.setText('Width' + (window.innerWidth) + '\nFlip up v0.0.2\nTurn all the tiles BLUE \nClick any tile to start \n\nCurrent Game: ' + (clockValue));

        }

    </script>

</body>

</html>